########################################################
# Intended for deployments at the health departments
#
# Provides IRIS client BFF and frontend together with a Postgresql database and NGINX
# IRIS frontend over NGINX: port = 443
########################################################
version: "3.4"
services:
  # Postgres Database
  postgres:
    image: postgres:13.2-alpine
    expose:
      - 5432
    environment:
      POSTGRES_USER:
      POSTGRES_PASSWORD:
    volumes:
      - psqldata_iris:/var/lib/postgresql/data

    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "psql",
          "-U",
          "${POSTGRES_USER}",
          "-c",
          "SELECT 1;",
          "${POSTGRES_USER}",
        ]
      interval: 15s
      timeout: 3s
      retries: 4
      start_period: 30s

  # IRIS Client backend for frontend
  iris-client:
    image: inoeg/iris-client-bff:develop
    expose:
      - 8092
    ports:
      - 8092:8092
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_USER}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      SPRING_PROFILES_ACTIVE: prod
      EPS_CLIENT_CLIENT_URL: https://eps:5556/jsonrpc
      SECURITY_JWT_JWT_SHARED_SECRET:
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy

  # IRIS Client Frontend for users
  iris-frontend:
    image: inoeg/iris-client-frontend:develop
    expose:
      - 28080
    environment:
      SORMAS_SIDECAR_BASE_URL: /api
    ports:
      - 28080:28080
    restart: unless-stopped
    depends_on:
      - iris-client

  # Endpoint server to communicate with Apps and IRIS Connect central services
  eps:
    image: luckylusa/iris-eps-bundle:latest
    expose:
      - 4446
      - 5556
    ports:
      - 4446:4446
    depends_on:
      - iris-client
    volumes:
      - ./conf/eps:/app/settings
    environment:
      - EPS_SETTINGS=settings/roles/hd
      - HTTPS_PROXY=https://host.docker.internal:8899
    command: ["--level", "debug", "server", "run"]

  # Reverse Proxy
  nginx:
    image: inoeg/iris-client-nginx:develop
    ports:
      - 443:443
    environment:
      IRIS_CLIENT_DOMAIN:
      IRIS_CLIENT_DOMAIN_CERT:
      IRIS_CLIENT_DOMAIN_CERT_KEY:
    volumes:
      - ./conf:/etc/iris
    depends_on:
      - iris-client
      - iris-frontend

volumes:
  psqldata_iris:
